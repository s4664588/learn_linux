# ç›®æ¨™ä¼ºæœå™¨ Dockerfile
FROM ubuntu:22.04

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV DEBIAN_FRONTEND=noninteractive

# å®‰è£æœå‹™å’Œå·¥å…·
RUN apt-get update && apt-get install -y \
    openssh-server \
    nginx \
    mysql-server \
    netcat \
    curl \
    wget \
    vim \
    net-tools \
    iputils-ping \
    sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# è¨­å®š root å¯†ç¢¼ï¼ˆç”¨æ–¼ SSH é€£ç·šæ¸¬è©¦ï¼‰
RUN echo "root:rootpassword" | chpasswd

# è¨­å®š SSH æœå‹™
RUN mkdir /var/run/sshd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# è¨­å®š Nginx å­—ç¬¦ç·¨ç¢¼
RUN echo 'server {\n\
    listen 80 default_server;\n\
    listen [::]:80 default_server;\n\
    root /var/www/html;\n\
    index index.html index.htm;\n\
    server_name _;\n\
    charset utf-8;\n\
    \n\
    location / {\n\
        try_files $uri $uri/ =404;\n\
        add_header Content-Type "text/html; charset=utf-8";\n\
    }\n\
    \n\
    location /api/info {\n\
        add_header Content-Type "text/plain; charset=utf-8";\n\
        fastcgi_pass unix:/var/run/fcgiwrap.socket;\n\
        fastcgi_param SCRIPT_FILENAME /usr/local/bin/api.sh;\n\
        fastcgi_param REQUEST_URI $request_uri;\n\
        include fastcgi_params;\n\
    }\n\
}' > /etc/nginx/sites-available/default

# è¨­å®š Nginxï¼ˆæ¨¡æ“¬ Web æœå‹™ï¼‰
RUN echo '<!DOCTYPE html>\n\
<html>\n\
<head>\n\
    <meta charset="UTF-8">\n\
    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n\
    <title>Target Server</title>\n\
    <style>\n\
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }\n\
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n\
        .server-info { background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #007acc; }\n\
        h1 { color: #333; text-align: center; }\n\
        h2 { color: #007acc; }\n\
        .status-success { color: #28a745; font-weight: bold; }\n\
        .service-list { background: #f8f9fa; padding: 15px; border-radius: 5px; }\n\
        .service-list li { margin: 5px 0; }\n\
    </style>\n\
</head>\n\
<body>\n\
    <div class="container">\n\
        <h1>ğŸ¯ Target Server</h1>\n\
        <div class="server-info">\n\
            <h2>ä¼ºæœå™¨è³‡è¨Š</h2>\n\
            <p><strong>ä¸»æ©Ÿåç¨±:</strong> <span id="hostname">è¼‰å…¥ä¸­...</span></p>\n\
            <p><strong>IP ä½å€:</strong> <span id="ip">è¼‰å…¥ä¸­...</span></p>\n\
            <p><strong>æœå‹™ç‹€æ…‹:</strong> <span class="status-success">âœ… é‹è¡Œä¸­</span></p>\n\
            <p><strong>SSH Tunnel æ¸¬è©¦:</strong> <span class="status-success">æˆåŠŸï¼</span></p>\n\
        </div>\n\
        <h3>ğŸ”— å¯ç”¨æœå‹™</h3>\n\
        <div class="service-list">\n\
            <ul>\n\
                <li>ğŸ“„ HTTP Web æœå‹™ (Port 80)</li>\n\
                <li>ğŸ” SSH æœå‹™ (Port 22)</li>\n\
                <li>ğŸ—„ï¸ MySQL æœå‹™ (Port 3306)</li>\n\
                <li>ğŸ–¥ï¸ æ¨¡æ“¬ RDP æœå‹™ (Port 3389)</li>\n\
            </ul>\n\
        </div>\n\
        <div style="margin-top: 20px; padding: 10px; background: #d4edda; border-radius: 5px; border: 1px solid #c3e6cb;">\n\
            <p><strong>ğŸ“¡ SSH Tunnel ç‹€æ…‹:</strong> é€é localhost:8090 æˆåŠŸå­˜å–å…§éƒ¨æœå‹™</p>\n\
        </div>\n\
    </div>\n\
    <script>\n\
        document.getElementById("hostname").textContent = window.location.hostname || "localhost";\n\
        fetch("/api/info").then(r=>r.text()).then(ip => {\n\
            document.getElementById("ip").textContent = ip || "å…§éƒ¨ç¶²è·¯";\n\
        }).catch(() => {\n\
            document.getElementById("ip").textContent = "å…§éƒ¨ç¶²è·¯ (10.100.0.x)";\n\
        });\n\
    </script>\n\
</body>\n\
</html>' > /var/www/html/index.html

# å»ºç«‹ç°¡å–®çš„ API ç«¯é»
RUN echo '#!/bin/bash\n\
if [[ "$REQUEST_URI" == "/api/info" ]]; then\n\
    echo "Content-Type: text/plain"\n\
    echo ""\n\
    hostname -I | tr -d " \\n"\n\
fi' > /usr/local/bin/api.sh && chmod +x /usr/local/bin/api.sh

# è¨­å®š MySQLï¼ˆåŸºæœ¬é…ç½®ï¼‰
RUN service mysql start && \
    mysql -e "CREATE USER 'testuser'@'%' IDENTIFIED BY 'testpass';" && \
    mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'testuser'@'%';" && \
    mysql -e "FLUSH PRIVILEGES;" && \
    service mysql stop

# å»ºç«‹å•Ÿå‹•è…³æœ¬
RUN echo '#!/bin/bash\n\
\n\
# è¨­å®šç³»çµ± locale æ”¯æ´ UTF-8\n\
export LANG=C.UTF-8\n\
export LC_ALL=C.UTF-8\n\
\n\
# å•Ÿå‹•æ‰€æœ‰æœå‹™\n\
service ssh start\n\
nginx -t && service nginx start\n\
service mysql start\n\
\n\
# å»ºç«‹æ¨¡æ“¬ RDP æœå‹™ï¼ˆä½¿ç”¨ netcat ç›£è½ 3389 portï¼‰\n\
nc -l -p 3389 -k -e /bin/echo "RDP Service Simulation" &\n\
\n\
# é¡¯ç¤ºä¼ºæœå™¨è³‡è¨Š\n\
echo "=== Target Server Started ==="\n\
echo "ä¼ºæœå™¨åç¨±: $SERVER_NAME"\n\
echo "IP ä½å€: $(hostname -I)"\n\
echo "å­—ç¬¦ç·¨ç¢¼: UTF-8"\n\
echo "å¯ç”¨æœå‹™:"\n\
echo "  - SSH (Port 22)"\n\
echo "  - HTTP (Port 80) - UTF-8 ç·¨ç¢¼"\n\
echo "  - MySQL (Port 3306)"\n\
echo "  - RDP æ¨¡æ“¬ (Port 3389)"\n\
echo "============================="\n\
\n\
# ä¿æŒå®¹å™¨é‹è¡Œ\n\
tail -f /dev/null' > /start.sh && chmod +x /start.sh

EXPOSE 22 80 3306 3389

CMD ["/start.sh"]

